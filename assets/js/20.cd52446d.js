(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{368:function(t,s,a){"use strict";a.r(s);var n=a(42),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"workmanager组件架构应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#workmanager组件架构应用"}},[t._v("#")]),t._v(" WorkManager组件架构应用")]),t._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[t._v("前面的内容中我们已经介绍了很多Jetpack中的架构组件，可以说每一种组件的出现都是为了更好的解决现在存在的问题。同样的，WorkManager的出现也是为了解决某一问题，试想这样一个场景：在做开发的时候总避免不了做些后台任务，好比我们的业务埋点的上传，正常我们用定时器也可以实现，但是一旦用户退出了应用，我们的应用到了后台，一旦遇到系统内存吃紧的情况，应用进程就会被杀掉了，遇到这种情况我们的埋点就没法上传了。")]),t._v(" "),a("p",[t._v("但是WorkManager的出现基本解决了这种问题，它可以"),a("strong",[t._v("在应用退出的时候依然执行一些异步任务。")])]),t._v(" "),a("p",[t._v("用官方的话来讲就是：WorkManager旨在用于可"),a("strong",[t._v("延迟运行")]),t._v("（即不需要立即运行）并且"),a("strong",[t._v("在应用退出或设备重启时必须能够可靠运行的任务。")])]),t._v(" "),a("h2",{attrs:{id:"提纲"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#提纲"}},[t._v("#")]),t._v(" 提纲")]),t._v(" "),a("ul",[a("li",[t._v("什么是WorkManager")]),t._v(" "),a("li",[t._v("如何使用WorkManager")]),t._v(" "),a("li",[t._v("WorkManager与Service")]),t._v(" "),a("li",[t._v("WorkManager工作原理")])]),t._v(" "),a("h2",{attrs:{id:"什么是workmanager"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是workmanager"}},[t._v("#")]),t._v(" 什么是WorkManager？")]),t._v(" "),a("p",[t._v("WorkManager是新一代后台任务的管理者，可以以轻松简单的方式实现复杂的后台任务控制。大量应用程序都有在后台执行任务的需求。根据需求的不同，Android为后台任务提供了多种解决方案，如JobScheduler，Loader，Service等。如果这些API没用被适当地使用，可能会消耗大量的电量。Android在解决应用程序耗电问题上做了各种尝试，从Doze到App Standby，通过各种方式限制和管理应用程序，以保证应用程序不会在后台过量消耗设备电量。WorkManager的出现，则是为应用程序中那些不需要及时完成的任务，提供统一的解决方案，以便在设备电量和用户体验之间达到一个比较好的平衡。")]),t._v(" "),a("p",[a("strong",[t._v("WorkManager的优势")])]),t._v(" "),a("ul",[a("li",[t._v("Workmanager确保任务可以被执行，在条件满足的时候会"),a("strong",[t._v("即便应用程序不在运行中也可以执行任务")]),t._v("；")]),t._v(" "),a("li",[t._v("WorkManager拥有丰富的任务控制手段和任务状态反馈，它提供多种方式控制任务是否继续执行，任务运行的每种状态都会以观察者的形式反馈；")]),t._v(" "),a("li",[t._v("多任务串联，例如执行任务A之前需要任务B和C先行完成，将会非常方便；")]),t._v(" "),a("li",[t._v("向前兼容支持到Api14，但会"),a("strong",[t._v("受到系统后台任务的限制管理以节省电量")]),t._v("，例如APP进行Doze Mode的时候，任务将不会被执行。")])]),t._v(" "),a("h2",{attrs:{id:"如何使用workmanager"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何使用workmanager"}},[t._v("#")]),t._v(" 如何使用WorkManager？")]),t._v(" "),a("p",[t._v("使用WorkManager之前同样要先添加依赖：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("implementation "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"androidx.work:work-runtime:2.4.0"')]),t._v("\n")])])]),a("p",[t._v("WorkManager的关键几个类介绍")]),t._v(" "),a("p",[t._v("由于该组件设计到的类比较多，所以在使用Work之前我们先来看一下Work组件中的几个关键类：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Worker：")]),t._v(" 任务的执行者，是一个抽象类，需要继承它实现要执行的任务；")]),t._v(" "),a("li",[a("strong",[t._v("WorkRequest：")]),t._v(" 每个任务在执行时都需要对构建一个WorkRequest对象，才能加入队列。有两个常用的子类OneTimeWorkRequest（任务只执行一遍）、PeriodicWorkRequest（任务周期性的执行）。")]),t._v(" "),a("li",[a("strong",[t._v("WorkManager：")]),t._v(" 管理任务请求和任务队列，发起的WorkRequest会进行它的任务队列；")]),t._v(" "),a("li",[a("strong",[t._v("WorkStatus：")]),t._v(" 包含有任务的状态和任务的信息，以LiveData的形式提供给观察者。")])]),t._v(" "),a("h3",{attrs:{id:"执行文件上传的任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#执行文件上传的任务"}},[t._v("#")]),t._v(" 执行文件上传的任务")]),t._v(" "),a("p",[t._v("文件上传的场景每个APP都会遇到，按照之间的写法，是非常麻烦的。但如果使用WorkManager将会非常轻松。")]),t._v(" "),a("p",[a("strong",[t._v("第一步，构建执行任务的类UploadFileWork")])]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UploadFileWorker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Worker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//需要让他继承自SDK提供的Worker父类")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UploadFileWorker")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@NonNull")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Context")]),t._v(" context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@NonNull")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkerParameters")]),t._v(" workerParams"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" workerParams"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@NonNull")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Result")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//任务的执行是在这里完成的，注意这里已经是运行在子线程里面的了")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//getInputData方法可以获取 执行任务时传递的参数Data对象，本质是hashMap的进一步封装，但是Data类传递的参数不能超过10Kb,而且只支持基本数据类型和他们的数组。")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Data")]),t._v(" inputData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInputData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//从入参中取出文件路径")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" filePath "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" inputData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"file"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//执行文件上传，得到文件的Url")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" fileUrl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FileUploadManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("upload")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filePath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//任务执行完，无论是成功失败，都需要返回Result对象。")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//此时它可以接收一个Data对象。用来承载文件上传得到的url")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Data")]),t._v(" outputData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Builder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("putString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fileUrl"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fileUrl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Result")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("outputData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Result.failure()")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("第二步，构建WorkRequest，可以使用下面的这两个子类来构建不同的Request对象")])]),t._v(" "),a("ul",[a("li",[t._v("OneTimeWorkRequest类：用以构建一次性任务的Request；")]),t._v(" "),a("li",[t._v("PeriodicWorkRequest类：用以构建周期性执行的任务Request，任务间隔最少是15分钟，所以保活就别想了。")])]),t._v(" "),a("p",[t._v("在构建Request对象的时候，提供了非常多的可选参数，可参考下面每个参数的作用。其中Builder（UploadFileWorker.class）必须指定。")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OneTimeWorkRequest")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("makeOneTimeWorkRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" filePath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//构建任务的入参对象")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Data")]),t._v(" inputData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Builder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("putString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"file"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filePath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//在构建request对象的时候，提供了非常多的参数，可以参考下面每个参数的作用")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//       Constraints constraints = new Constraints();")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        //设备存储空间充足的时候 才能执行 ,>15%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        constraints.setRequiresStorageNotLow(true);")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        //必须在执行的网络条件下才能好执行,不计流量 ,wifi")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        constraints.setRequiredNetworkType(NetworkType.UNMETERED);")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        //设备的充电量充足的才能执行 >15%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        constraints.setRequiresBatteryNotLow(true);")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        //只有设备在充电的情况下 才能允许执行")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        constraints.setRequiresCharging(true);")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        //只有设备在空闲的情况下才能被执行 比如息屏，cpu利用率不高")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        constraints.setRequiresDeviceIdle(true);")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        //workmanager利用contentObserver监控传递进来的这个uri对应的内容是否发生变化,当且仅当它发生变化了我们的任务才会被触发执行，")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        以下三个api是关联的")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        constraints.setContentUriTriggers(Uri.from('file'));")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        //设置从content变化到被执行中间的延迟时间，如果在这期间。content发生了变化，延迟时间会被重新计算")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//这个content就是指 我们设置的setContentUriTriggers uri对应的内容")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        constraints.setTriggerContentUpdateDelay(0);")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        //设置从content变化到被执行中间的最大延迟时间")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//这个content就是指 我们设置的setContentUriTriggers uri对应的内容")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//        constraints.setTriggerMaxContentDelay(0);")]),t._v("\n      \n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OneTimeWorkRequest")]),t._v(" request "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OneTimeWorkRequest")]),t._v("\n                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//执行任务的class对象")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Builder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UploadFileWorker")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//传递任务执行的入参")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInputData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inputData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                .setConstraints(constraints)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                //设置一个拦截器，在任务执行之前 可以做一次拦截，去修改入参的数据然后返回新的数据交由worker使用")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                .setInputMerger(null)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                //当一个任务被调度失败后，所要采取的重试策略，可以通过BackoffPolicy来执行具体的策略")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                .setBackoffCriteria(BackoffPolicy.EXPONENTIAL, 10, TimeUnit.SECONDS)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                //任务被调度执行的延迟时间")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                .setInitialDelay(10, TimeUnit.SECONDS)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                //设置该任务尝试执行的最大次数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                .setInitialRunAttemptCount(2)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                //设置这个任务开始执行的时间  System.currentTimeMillis()")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                .setPeriodStartTime(0, TimeUnit.SECONDS)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                //当一个任务执行状态变成finish时，又没有后续的观察者来消费这个结果，难么workamnager会在")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                //内存中保留一段时间的该任务的结果。超过这个时间，这个结果就会被存储到数据库中")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                //下次想要查询该任务的结果时，会触发workmanager的数据库查询操作，可以通过uuid来查询任务的状态")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                .keepResultsForAtLeast(10, TimeUnit.SECONDS)")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("第三步，把任务加入工作队列")])]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//1.把任务加入队列，在合适的时机会被执行")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//2.如果多个任务之间存在依赖关系，此时可以使用如下方式")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//此时 是requestA 和 requestB都执行完才会去执行requestC,requestC执行完才会去执行requestD")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkContinuation")]),t._v(" chain "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("application"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("beginWith")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("requestB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nchain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nchain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//3.再来个复杂点的  requestA->requestB--\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                                   >>> requestE.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                requestC->requestD--/  ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//这个场景是 A,C同时并发执行，A执行完执行B，C执行完执行D，BD同时执行完才执行E.")]),t._v("\nval chainAB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("beginWith")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nval chainCD "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("beginWith")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nval chain "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkContinuation")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("combine")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chainAB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" chainCD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nchain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("enqueue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//可以看到尽管任务链关系很复杂，但是workmanager可以轻易实现。")]),t._v("\n")])])]),a("p",[t._v("###　任务状态监听")]),t._v(" "),a("p",[t._v("每个任务加入队列之后，都会有以下7种状态：")]),t._v(" "),a("ul",[a("li",[t._v("*BLOCKED：*任务阻塞中；")]),t._v(" "),a("li",[t._v("*ENQUEUED：*队列等待中；")]),t._v(" "),a("li",[t._v("*RUNNING：*任务执行中；")]),t._v(" "),a("li",[t._v("*SUCCESSED：*任务执行成功；")]),t._v(" "),a("li",[t._v("*CANCELED：*任务取消；")]),t._v(" "),a("li",[t._v("*FAILED：*任务失败；")]),t._v(" "),a("li",[t._v("*FINISHED：*任务结束。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/jarrysong/img/raw/master/img/5196125-1f5d2e7f28781369.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//根据UUID获取任务  并监听它的状态。uuid可以通过request.getId()得到。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//可以把该uuid存储本地，以至于在任意页面都可以查询任务的执行状态")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getWorkInfoById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uuid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("observer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//根据任务的tag获取一组任务，并监听他们的状态")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getWorkInfosByTag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("observer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//得到队列中所有的任务 并获取他们的状态")]),t._v("\nworkContinuation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getWorkInfosLiveData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("observe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PublishActivity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Observer")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onChanged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" workInfos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//任务的状态有六种分别是：")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//block runing enuqued failed susscess finish")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkInfo")]),t._v(" workInfo "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" workInfos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("State")]),t._v(" state "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" workInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Data")]),t._v(" outputData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" workInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getOutputData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UUID")]),t._v(" uuid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" workInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("State")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("FAILED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// if (uuid==coverUploadUUID)是错的，")]),t._v("\n                        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//coverUploadUUID = request,getId()得到")]),t._v("\n                        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uuid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("equals")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("coverUploadUUID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                           \n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("State")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SUCCEEDED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                           \n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n                      \n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"任务控制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务控制"}},[t._v("#")]),t._v(" 任务控制")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("取消所有任务；")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cancelAllWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("根据任务的tag取消，如果多个任务拥有同一个tag，那么它们都会被取消；")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cancelAllWorkByTag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tag"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("根据任务名称取消任务；")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cancelUniqueWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"uploadfile"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("根据任务的UUID取消某个任务。")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WorkManager")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cancelWorkById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])]),t._v(" "),a("h2",{attrs:{id:"workmanager与service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#workmanager与service"}},[t._v("#")]),t._v(" WorkManager与Service")]),t._v(" "),a("p",[t._v("WorkManager区别于异步任务，它更像是"),a("strong",[t._v("一个系统级的后台服务。")]),t._v(" 基本上，Workmanager能做的，Service也能做；但反观Service，泛滥的Service后台任务可能是引起Android系统卡顿的主要原因，这几年Google也对Service也做了一些限制：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("休眠模式：")]),t._v(" Android 6.0(API 23)在关闭手机屏幕后，系统会禁止应用的后台任务网络请求等功能；")]),t._v(" "),a("li",[a("strong",[t._v("后台启动：")]),t._v(" Android 8.0(API 26)在后台不允许启动Service，会抛异常。")])]),t._v(" "),a("p",[t._v("而WorkManager作为一个更合理的后台任务管理库，我们可以将一些诸如埋点、日志上报等费劲及执行的后台任务转义到WorkManager来实现。")]),t._v(" "),a("h2",{attrs:{id:"workmanager工作原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#workmanager工作原理"}},[t._v("#")]),t._v(" WorkManager工作原理")]),t._v(" "),a("p",[t._v("我们使用WorkManager构建的这些任务，在"),a("strong",[t._v("加入任务队列之后都会被保存到数据库")]),t._v("，所以哪怕程序退出了，这些任务也能够被执行。如果在"),a("strong",[t._v("调度任务时我们的APP在运行中，此时会选择线程池来执行")]),t._v("，如果在调度任务时我们的APP没有运行，在"),a("strong",[t._v("5.0及以上版本会选择JobScheduler来调度，5.0以下会使用AlarmManager来调度任务。")]),t._v(" 任务执行的"),a("strong",[t._v("状态和结果都会被持久化到数据库。")]),t._v(" APP下次启动时，也可以去查询任务的执行结果。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/jarrysong/img/raw/master/img/5196125-2804d083edd19a98.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("对于需要立刻执行的任务还是不能使用WorkManager来调度，因为WorkManager的任务调度会收到系统当前状态的影响。虽然官方说即便应用退出了，也能保障任务得到执行，这一点在模拟器和Pixel手机上是得到验证的。但是国内手机Rom版本众多，还需要亲自验证才能知道。")])])}),[],!1,null,null,null);s.default=e.exports}}]);