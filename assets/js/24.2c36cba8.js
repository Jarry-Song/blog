(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{372:function(t,s,a){"use strict";a.r(s);var n=a(42),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"探秘kotlin协程机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#探秘kotlin协程机制"}},[t._v("#")]),t._v(" 探秘Kotlin协程机制")]),t._v(" "),a("ul",[a("li",[t._v("什么是协程")]),t._v(" "),a("li",[t._v("协程的用法")]),t._v(" "),a("li",[t._v("协程的启动")]),t._v(" "),a("li",[t._v("协程挂起,恢复原理逆向剖析")])]),t._v(" "),a("h2",{attrs:{id:"什么是协程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是协程"}},[t._v("#")]),t._v(" 什么是协程")]),t._v(" "),a("h3",{attrs:{id:"场景1-异步回调嵌套"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#场景1-异步回调嵌套"}},[t._v("#")]),t._v(" 场景1:异步回调嵌套")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://doc.devio.org/as/book/docs/Part2/%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%BC%80%E5%8F%91%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/coroutine_1.png",alt:"coroutine_1"}})]),t._v(" "),a("div",{staticClass:"language-kotlin extra-class"},[a("pre",{pre:!0,attrs:{class:"language-kotlin"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//客户端顺序进行三次网络异步请求，并用最终结果更新UI")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parameter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" value1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" value2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" value3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateUI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("            \n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("              \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("这种结构的代码无论是阅读起来还是维护起来都是极其糟糕的。"),a("strong",[t._v('对多个回调组成的嵌套耦合，我亲切地称为 "回调地狱"。')])]),t._v(" "),a("blockquote",[a("p",[t._v("协程的写法")])]),t._v(" "),a("div",{staticClass:"language-kotlin extra-class"},[a("pre",{pre:!0,attrs:{class:"language-kotlin"}},[a("code",[t._v("GlobalScope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("launch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Dispatchers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" value1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" value2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" value3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value2）\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateUI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("suspend")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("suspend")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("suspend")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h3",{attrs:{id:"场景2-并发流程控制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#场景2-并发流程控制"}},[t._v("#")]),t._v(" 场景2：并发流程控制")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://doc.devio.org/as/book/docs/Part2/%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%BC%80%E5%8F%91%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/coroutine2.png",alt:"coroutine2"}})]),t._v(" "),a("div",{staticClass:"language-kotlin extra-class"},[a("pre",{pre:!0,attrs:{class:"language-kotlin"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//客户端顺序并发三次网络异步请求，并用最终结果更新UI")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parameter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" value1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" value2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value2"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("value2   \n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateUI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("       \n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" value3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value3"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("value3                \n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateUI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("     \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("                                  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateUI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("协程写法")])]),t._v(" "),a("div",{staticClass:"language-kotlin extra-class"},[a("pre",{pre:!0,attrs:{class:"language-kotlin"}},[a("code",[t._v("GlobalScope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("launch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Dispatchers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" value1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" deferred2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" GlobalScope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("async")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" deferred3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" GlobalScope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("async")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateUI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deferred2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("await")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("deferred3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("await")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("suspend")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("suspend")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("suspend")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[a("strong",[t._v("协程的目的是为了让多个任务之间更好的协作,解决异步回调嵌套。能够以同步的方式编排代码完成异步工作。将异步代码像同步代码一样直观。同时它也是一个并发流程控制的解决方案。")])]),t._v(" "),a("p",[t._v("协程主要是"),a("strong",[t._v("让原来要使用“异步+回调”写出来的复杂代码, 简化成看似同步写出来的方式")]),t._v(",弱化了线程的概念（对线程的操作进一步抽象）")]),t._v(" "),a("h2",{attrs:{id:"协程的用法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协程的用法"}},[t._v("#")]),t._v(" 协程的用法")]),t._v(" "),a("h3",{attrs:{id:"引入gradle依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#引入gradle依赖"}},[t._v("#")]),t._v(" 引入gradle依赖")]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[t._v("//在kotlin项目中配合jetpack架构引入协程\napi 'androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0'\napi 'androidx.lifecycle:lifecycle-runtime-ktx:2.2.0'\napi 'androidx.lifecycle:lifecycle-livedata-ktx:2.2.0'\n\n//在kotlin项目但非jetpack 架构项目中引入协程\napi \"org.jetbrains.kotlinx:kotlinx-coroutines-core:1.2.1\"\napi 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.1.1'\n")])])]),a("h3",{attrs:{id:"常用的创建协程的方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用的创建协程的方法"}},[t._v("#")]),t._v(" 常用的创建协程的方法")]),t._v(" "),a("div",{staticClass:"language-kotlin extra-class"},[a("pre",{pre:!0,attrs:{class:"language-kotlin"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//创建协程时,可以通过Dispatchers.IO,MAIN,Unconfined指定协程运行的线程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" job"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("Job "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("GlobalScope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("launch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Dispatchers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" deffered"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("Deffered"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("GlobalScope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("async（Dispatchers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("IO）\n")])])]),a("p",[t._v("Job：协程构建函数的返回值，可以把 Job 看成协程对象本身，包含了对协程的控制方法。")]),t._v(" "),a("p",[t._v("Deffered是Job的子类，实际上就增加了个await方法。能够让当前协程暂时挂起,暂停往下执行。当await方法有返回值后,会恢复协程,继续往下执行")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("方法")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("start()")]),t._v(" "),a("td",[t._v("手动启动协程")])]),t._v(" "),a("tr",[a("td",[t._v("join()")]),t._v(" "),a("td",[t._v("等待协程执行完毕")])]),t._v(" "),a("tr",[a("td",[t._v("cancel()")]),t._v(" "),a("td",[t._v("取消一个协程")])])])]),t._v(" "),a("h3",{attrs:{id:"协程的启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协程的启动"}},[t._v("#")]),t._v(" 协程的启动")]),t._v(" "),a("div",{staticClass:"language-kotlin extra-class"},[a("pre",{pre:!0,attrs:{class:"language-kotlin"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" CoroutineScope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("launch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    context"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" CoroutineContext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" EmptyCoroutineContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    start"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" CoroutineStart "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" CoroutineStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    block"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("suspend")]),t._v(" CoroutineScope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" Unit\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Job"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" newContext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("newCoroutineContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" coroutine "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("StandaloneCoroutine")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" active "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  coroutine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" coroutine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" block"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("CoroutineContext - 可以理解为协程的上下文，是一种key-value数据结构")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("CoroutineContext")]),t._v(" "),a("th",[t._v("List")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("get(key: Key): E")]),t._v(" "),a("td",[t._v("get(int index)")])]),t._v(" "),a("tr",[a("td",[t._v("plus(context: Element)")]),t._v(" "),a("td",[t._v("add(int index, E element)")])]),t._v(" "),a("tr",[a("td",[t._v("minusKey(key: Key<*>)")]),t._v(" "),a("td",[t._v("remove(E element)")])])])]),t._v(" "),a("p",[t._v("CoroutineDispatcher 协程运行的线程调度器")]),t._v(" "),a("h3",{attrs:{id:"协程调度器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协程调度器"}},[t._v("#")]),t._v(" 协程调度器")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://doc.devio.org/as/book/docs/Part2/%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%BC%80%E5%8F%91%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/coroutine_dispatcher.png",alt:"coroutine_dispatcher"}})]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("模式")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Dispatchers.IO")]),t._v(" "),a("td",[t._v("显示指定协程运行的线程,为IO线程")])]),t._v(" "),a("tr",[a("td",[t._v("Dispatchers.Main")]),t._v(" "),a("td",[t._v("指定这个协程运行在主线程")])]),t._v(" "),a("tr",[a("td",[t._v("Dispatchers.Default")]),t._v(" "),a("td",[t._v("默认的,启动携程时会启动一个线程")])]),t._v(" "),a("tr",[a("td",[t._v("Dispatchers.Unconfined")]),t._v(" "),a("td",[t._v("不指定，就是在当前线程运行,协程恢复后的运行的线程取决于协程挂起时所在的线程")])])])]),t._v(" "),a("h3",{attrs:{id:"coroutinestart-启动模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#coroutinestart-启动模式"}},[t._v("#")]),t._v(" CoroutineStart - 启动模式")]),t._v(" "),a("p",[t._v("默认是DEAFAULT，也就是创建就启动；还有一个是LAZY，意思是等你需要它的时候，再调用启动")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("模式")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("CoroutineStart().DEAFAULT")]),t._v(" "),a("td",[t._v("模式模式，创建即启动协程,可随时取消")])]),t._v(" "),a("tr",[a("td",[t._v("ATOMIC")]),t._v(" "),a("td",[t._v("自动模式,同样创建即启动,但启动前不可取")])]),t._v(" "),a("tr",[a("td",[t._v("LAZY")]),t._v(" "),a("td",[t._v("延迟启动模式，只有当调用start方法时才会启动")])])])]),t._v(" "),a("h2",{attrs:{id:"协程挂起-恢复原理逆向剖析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协程挂起-恢复原理逆向剖析"}},[t._v("#")]),t._v(" 协程挂起,恢复原理逆向剖析")]),t._v(" "),a("h3",{attrs:{id:"挂起函数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#挂起函数"}},[t._v("#")]),t._v(" 挂起函数")]),t._v(" "),a("p",[a("strong",[t._v("被关键字|suspend|修饰的方法在编译阶段,编译器会修改方法的签名.包括返回值,修饰符,入参,方法体实现")]),t._v("。协程的挂起是靠挂起函数中实现的代码。")]),t._v(" "),a("div",{staticClass:"language-kotlin extra-class"},[a("pre",{pre:!0,attrs:{class:"language-kotlin"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("suspend")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" String "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("delay")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//suspend fun()")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"after delay"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"result from request"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" static "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" Object "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Continuation completion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  ContinuationImpl requestContinuation "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" completion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("completion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("label & Integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MIN_VALUE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n            requestContinuation "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" new "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ContinuationImpl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("completion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@Override")]),t._v("\n                Object "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("invokeSuspend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Object o"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    label |"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MIN_VALUE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("switch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestContinuation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("label"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            case "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                requestContinuation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("label "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                Object delay "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" DelayKt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("delay")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" requestContinuation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("delay "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" COROUTINE_SUSPENDED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" COROUTINE_SUSPENDED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  System"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"after delay"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"result from request"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"协程挂起与协程恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协程挂起与协程恢复"}},[t._v("#")]),t._v(" 协程挂起与协程恢复")]),t._v(" "),a("p",[a("strong",[t._v("协程的核心是挂起----恢复,挂起--恢复的本质是return & callback回调")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://doc.devio.org/as/book/docs/Part2/%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%BC%80%E5%8F%91%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/coroutine_resume.png",alt:"coroutine_resume"}})]),t._v(" "),a("h2",{attrs:{id:"协程回顾"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协程回顾"}},[t._v("#")]),t._v(" 协程回顾")]),t._v(" "),a("ul",[a("li",[a("p",[a("strong",[t._v("什么是协程")])]),t._v(" "),a("ul",[a("li",[t._v("协程是一种解决方案，是一种解决嵌套,并发,弱化线程概念的方案。能让多个任务之间更好的协作,能够以同步的方式编排代码完成异步工作。将异步代码写的像同步代码一样直观。")])])]),t._v(" "),a("li",[a("p",[a("em",[t._v("协程的启动")])]),t._v(" "),a("ul",[a("li",[t._v("根据创建协程指定的调度器HandlerDispatcher,DefaultScheduler,UnconfinedDispatcher来执行任务,以决定协程中的代码块运行在那个线程上。")])])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("协程的挂起，恢复")])]),t._v(" "),a("ul",[a("li",[t._v("本质是方法的挂起，恢复。本质是return +callback。")]),t._v(" "),a("li",[t._v("用编译时的变换处理方法间的callback，这样可以很直观地写顺序执行的异步代码。")])])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("协程是线程框架吗？")])]),t._v(" "),a("ul",[a("li",[t._v("协程的本质是编译时return +callback。只不过在调度任务时提供了能够\n运行在IO线程的调度器。")])])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("什么时候使用协程")])]),t._v(" "),a("ul",[a("li",[t._v("多任务并发流程控制场景使用比较好, 流程控制比较简单,不会涉及线程\n阻塞与唤醒，性能比java并发控制手段高。")])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);