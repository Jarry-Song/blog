<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Room组件架构原理解析 | Android Nodes</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="欲速则不达，起于累土">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/blog/assets/css/0.styles.c59328e2.css" as="style"><link rel="preload" href="/blog/assets/js/app.b29a8dd7.js" as="script"><link rel="preload" href="/blog/assets/js/2.f6cef42b.js" as="script"><link rel="preload" href="/blog/assets/js/17.4908b8a7.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.7a48b7c5.js"><link rel="prefetch" href="/blog/assets/js/11.eac2ba23.js"><link rel="prefetch" href="/blog/assets/js/12.0f90fab7.js"><link rel="prefetch" href="/blog/assets/js/13.bec57e62.js"><link rel="prefetch" href="/blog/assets/js/14.3ae2a79a.js"><link rel="prefetch" href="/blog/assets/js/15.a791971b.js"><link rel="prefetch" href="/blog/assets/js/16.e5da048d.js"><link rel="prefetch" href="/blog/assets/js/18.46af3ffd.js"><link rel="prefetch" href="/blog/assets/js/19.89281622.js"><link rel="prefetch" href="/blog/assets/js/20.cd52446d.js"><link rel="prefetch" href="/blog/assets/js/21.82cce5e6.js"><link rel="prefetch" href="/blog/assets/js/22.80975ead.js"><link rel="prefetch" href="/blog/assets/js/23.96416586.js"><link rel="prefetch" href="/blog/assets/js/24.2c36cba8.js"><link rel="prefetch" href="/blog/assets/js/25.367808ef.js"><link rel="prefetch" href="/blog/assets/js/26.be8af843.js"><link rel="prefetch" href="/blog/assets/js/27.b222d373.js"><link rel="prefetch" href="/blog/assets/js/28.a12c5df9.js"><link rel="prefetch" href="/blog/assets/js/29.d5ff3c40.js"><link rel="prefetch" href="/blog/assets/js/3.6d59dab0.js"><link rel="prefetch" href="/blog/assets/js/30.cbbb74b5.js"><link rel="prefetch" href="/blog/assets/js/31.b75f6d67.js"><link rel="prefetch" href="/blog/assets/js/32.86d96ea4.js"><link rel="prefetch" href="/blog/assets/js/33.46446d62.js"><link rel="prefetch" href="/blog/assets/js/34.8408a108.js"><link rel="prefetch" href="/blog/assets/js/35.98c56f35.js"><link rel="prefetch" href="/blog/assets/js/36.bdaeac6f.js"><link rel="prefetch" href="/blog/assets/js/37.533f8161.js"><link rel="prefetch" href="/blog/assets/js/38.0200746e.js"><link rel="prefetch" href="/blog/assets/js/39.c88574ea.js"><link rel="prefetch" href="/blog/assets/js/4.1ea1eeff.js"><link rel="prefetch" href="/blog/assets/js/40.45749e2b.js"><link rel="prefetch" href="/blog/assets/js/41.f908dd77.js"><link rel="prefetch" href="/blog/assets/js/42.6a921fb9.js"><link rel="prefetch" href="/blog/assets/js/43.a545ead3.js"><link rel="prefetch" href="/blog/assets/js/44.599973fd.js"><link rel="prefetch" href="/blog/assets/js/45.4f5aa578.js"><link rel="prefetch" href="/blog/assets/js/46.bc77698b.js"><link rel="prefetch" href="/blog/assets/js/47.6fab262f.js"><link rel="prefetch" href="/blog/assets/js/48.06721492.js"><link rel="prefetch" href="/blog/assets/js/49.ddd2004c.js"><link rel="prefetch" href="/blog/assets/js/5.7d990afd.js"><link rel="prefetch" href="/blog/assets/js/50.68d30b00.js"><link rel="prefetch" href="/blog/assets/js/51.1e95b300.js"><link rel="prefetch" href="/blog/assets/js/52.7e58153e.js"><link rel="prefetch" href="/blog/assets/js/53.49c83746.js"><link rel="prefetch" href="/blog/assets/js/54.cafb7c5d.js"><link rel="prefetch" href="/blog/assets/js/55.e3a5298e.js"><link rel="prefetch" href="/blog/assets/js/56.16a6fa14.js"><link rel="prefetch" href="/blog/assets/js/57.a5849246.js"><link rel="prefetch" href="/blog/assets/js/58.21f63823.js"><link rel="prefetch" href="/blog/assets/js/59.1de0dd4e.js"><link rel="prefetch" href="/blog/assets/js/6.cec4111c.js"><link rel="prefetch" href="/blog/assets/js/60.d486fda7.js"><link rel="prefetch" href="/blog/assets/js/61.2df18a41.js"><link rel="prefetch" href="/blog/assets/js/62.f167b5ca.js"><link rel="prefetch" href="/blog/assets/js/63.1a1ddafe.js"><link rel="prefetch" href="/blog/assets/js/64.4ba3449a.js"><link rel="prefetch" href="/blog/assets/js/65.8005097c.js"><link rel="prefetch" href="/blog/assets/js/66.5d3693a7.js"><link rel="prefetch" href="/blog/assets/js/67.e9d7bf30.js"><link rel="prefetch" href="/blog/assets/js/68.1efe09bb.js"><link rel="prefetch" href="/blog/assets/js/69.50f5445d.js"><link rel="prefetch" href="/blog/assets/js/7.9d95edae.js"><link rel="prefetch" href="/blog/assets/js/70.02047906.js"><link rel="prefetch" href="/blog/assets/js/71.634bd610.js"><link rel="prefetch" href="/blog/assets/js/72.a00660d0.js"><link rel="prefetch" href="/blog/assets/js/73.cb4a91db.js"><link rel="prefetch" href="/blog/assets/js/74.3f83725a.js"><link rel="prefetch" href="/blog/assets/js/75.89822bf9.js"><link rel="prefetch" href="/blog/assets/js/76.9c29fa27.js"><link rel="prefetch" href="/blog/assets/js/77.0e21a0d0.js"><link rel="prefetch" href="/blog/assets/js/78.83828550.js"><link rel="prefetch" href="/blog/assets/js/79.038d118d.js"><link rel="prefetch" href="/blog/assets/js/8.b3b24cde.js"><link rel="prefetch" href="/blog/assets/js/80.4ed5e1a3.js"><link rel="prefetch" href="/blog/assets/js/81.d08345df.js"><link rel="prefetch" href="/blog/assets/js/82.b6dfa43b.js"><link rel="prefetch" href="/blog/assets/js/83.78d8aa89.js"><link rel="prefetch" href="/blog/assets/js/84.9ecbf7a5.js"><link rel="prefetch" href="/blog/assets/js/85.49225f21.js"><link rel="prefetch" href="/blog/assets/js/86.29868731.js"><link rel="prefetch" href="/blog/assets/js/87.f05ddddc.js"><link rel="prefetch" href="/blog/assets/js/88.9703366d.js"><link rel="prefetch" href="/blog/assets/js/89.0a340baa.js"><link rel="prefetch" href="/blog/assets/js/9.5eb0e890.js"><link rel="prefetch" href="/blog/assets/js/90.af7d5cb4.js"><link rel="prefetch" href="/blog/assets/js/91.e94154f4.js"><link rel="prefetch" href="/blog/assets/js/92.32326a59.js"><link rel="prefetch" href="/blog/assets/js/93.12ad3fb5.js"><link rel="prefetch" href="/blog/assets/js/94.045060fa.js"><link rel="prefetch" href="/blog/assets/js/95.5c510610.js"><link rel="prefetch" href="/blog/assets/js/96.5bcee9fd.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.c59328e2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Android Nodes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/zh/guide/" class="nav-link">
  备忘录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Android" class="dropdown-title"><span class="title">Android</span> <span class="arrow down"></span></button> <button type="button" aria-label="Android" class="mobile-dropdown-title"><span class="title">Android</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/zh/android/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/ui/" class="nav-link">
  高级UI
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/architecture/" class="nav-link">
  架构设计
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/performance/" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/ndk/" class="nav-link">
  NDK
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/framework/" class="nav-link">
  开源框架
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/jetpack/" class="nav-link router-link-active">
  Jetpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/kotlin/" class="nav-link">
  Kotlin
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/zh/java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/java/structures/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/java/algorithms/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/java/exercise/" class="nav-link">
  算法练习
</a></li></ul></div></div><div class="nav-item"><a href="/blog/zh/net/" class="nav-link">
  API
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          代码管理
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/zh/api/cli.html" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/blog/zh/api/node.html" class="nav-link">
  分支管理
</a></li></ul></li><li class="dropdown-item"><h4>
          开发规范
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/zh/miscellaneous/local-development.html" class="nav-link">
  代码规范
</a></li><li class="dropdown-subitem"><a href="/blog/zh/miscellaneous/design-concepts.html" class="nav-link">
  团队协作
</a></li><li class="dropdown-subitem"><a href="/blog/zh/faq/" class="nav-link">
  需求与工作分配
</a></li><li class="dropdown-subitem"><a href="/blog/zh/miscellaneous/glossary.html" class="nav-link">
  文档沉淀
</a></li></ul></li><li class="dropdown-item"><h4>
          软实力
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/zh/miscellaneous/migration-guide.html" class="nav-link">
  必备技能
</a></li><li class="dropdown-subitem"><a href="https://github.com/vuejs/vuepress/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  团队管理
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/zh/guide/" class="nav-link">
  备忘录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Android" class="dropdown-title"><span class="title">Android</span> <span class="arrow down"></span></button> <button type="button" aria-label="Android" class="mobile-dropdown-title"><span class="title">Android</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/zh/android/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/ui/" class="nav-link">
  高级UI
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/architecture/" class="nav-link">
  架构设计
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/performance/" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/ndk/" class="nav-link">
  NDK
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/framework/" class="nav-link">
  开源框架
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/jetpack/" class="nav-link router-link-active">
  Jetpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/android/kotlin/" class="nav-link">
  Kotlin
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/zh/java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/java/structures/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/java/algorithms/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/java/exercise/" class="nav-link">
  算法练习
</a></li></ul></div></div><div class="nav-item"><a href="/blog/zh/net/" class="nav-link">
  API
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          代码管理
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/zh/api/cli.html" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/blog/zh/api/node.html" class="nav-link">
  分支管理
</a></li></ul></li><li class="dropdown-item"><h4>
          开发规范
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/zh/miscellaneous/local-development.html" class="nav-link">
  代码规范
</a></li><li class="dropdown-subitem"><a href="/blog/zh/miscellaneous/design-concepts.html" class="nav-link">
  团队协作
</a></li><li class="dropdown-subitem"><a href="/blog/zh/faq/" class="nav-link">
  需求与工作分配
</a></li><li class="dropdown-subitem"><a href="/blog/zh/miscellaneous/glossary.html" class="nav-link">
  文档沉淀
</a></li></ul></li><li class="dropdown-item"><h4>
          软实力
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/zh/miscellaneous/migration-guide.html" class="nav-link">
  必备技能
</a></li><li class="dropdown-subitem"><a href="https://github.com/vuejs/vuepress/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  团队管理
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Jetpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/zh/android/jetpack/" aria-current="page" class="sidebar-link">走进Jetpack框架组件库</a></li><li><a href="/blog/zh/android/jetpack/livecycle.html" class="sidebar-link">Livecycle</a></li><li><a href="/blog/zh/android/jetpack/livedata-1.html" class="sidebar-link">LiveData架构组件原理解析</a></li><li><a href="/blog/zh/android/jetpack/livedata-2.html" class="sidebar-link">LiveData实战与应用</a></li><li><a href="/blog/zh/android/jetpack/viewmodel.html" class="sidebar-link">ViewModel 组件架构原理解析</a></li><li><a href="/blog/zh/android/jetpack/savedstate.html" class="sidebar-link">SaveState组件架构原理解析</a></li><li><a href="/blog/zh/android/jetpack/room.html" aria-current="page" class="active sidebar-link">Room组件架构原理解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/zh/android/jetpack/room.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/zh/android/jetpack/room.html#提纲" class="sidebar-link">提纲</a></li><li class="sidebar-sub-header"><a href="/blog/zh/android/jetpack/room.html#什么是room" class="sidebar-link">什么是Room？</a></li><li class="sidebar-sub-header"><a href="/blog/zh/android/jetpack/room.html#room高频用法" class="sidebar-link">Room高频用法</a></li><li class="sidebar-sub-header"><a href="/blog/zh/android/jetpack/room.html#据库创建实现原理" class="sidebar-link">据库创建实现原理</a></li><li class="sidebar-sub-header"><a href="/blog/zh/android/jetpack/room.html#room搭配livedata监听数据变更自动刷新页面实现原理" class="sidebar-link">Room搭配LiveData监听数据变更自动刷新页面实现原理</a></li><li class="sidebar-sub-header"><a href="/blog/zh/android/jetpack/room.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/blog/zh/android/jetpack/workmanager.html" class="sidebar-link">WorkManager组件架构应用</a></li><li><a href="/blog/zh/android/jetpack/databinding.html" class="sidebar-link">DataBinding组件架构应用</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="room组件架构原理解析"><a href="#room组件架构原理解析" class="header-anchor">#</a> Room组件架构原理解析</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>Android应用数据存储简单来说有这么几种：文件存储、SharePreference存储、SQLite数据库存储。如果需要存储的数据量大的时候，那么使用文件存储会有很大的弊端，例如：你想修改其中很微小的项就要先读取整个文件的内容，修改后再全部保存，非常耗时。SharePreference大多数用来存储键值对形式的少量数据。所以SQLite数据库存储使用的场景还是非常高的，但是到目前Android10.0为止，原生的SQLite都不是那么友好，使得我们不得不经常引入其他三方ORM库。因为在Jetpack的架构下，Room数据库组件顺势而生。</p> <h2 id="提纲"><a href="#提纲" class="header-anchor">#</a> 提纲</h2> <ul><li>什么是Room</li> <li>Room的高频用法</li> <li>Room数据库创建实现原理</li> <li>Room与LiveData的巧妙结合，数据变更监听</li></ul> <h2 id="什么是room"><a href="#什么是room" class="header-anchor">#</a> 什么是Room？</h2> <p>Room是一个轻量级ORM数据库，本质上是一个SQLite抽象层，但是使用起来会更加简单，类似于Retrofit库。Room在开发阶段通过注解的方式标记相关功能，编译时自动生成响应的impl实现类。</p> <p>而且编译阶段会有丰富的语法校验，错误提示。相比如直接使用SQLite来创建数据库，来操作数据，实在是方便的太多了。带回咱们会手写来感受一下，Room是如何创建数据库的。</p> <p>我们对一个ORM数据库的要求不仅仅要简单好用，足够的检验，丰富的错误提示。它的性能我们应该更加关注。这里引用的一张图展示了GreenDAO，ORMLite，Room三者执行insert、update、query三种操作时的耗时对比。</p> <p>很明显，三项测试红色的Room好使都比其他两者低。由于Room是对原生SQLite的封装，所以它的性能几乎和SQLite相当，如果你的APP不是像微信这种级别的数据存储要求，那么Room是够用了的。</p> <p><img src="https://gitee.com/jarrysong/img/raw/master/img/20201128221326.png" alt=""></p> <h2 id="room高频用法"><a href="#room高频用法" class="header-anchor">#</a> Room高频用法</h2> <p>在开始学习Room数据库之前先来回忆一下直接使用SQLite该怎么创建一个数据库出来，以及它现在存在的问题。</p> <p>从下面这段代码上我们可以发现直接使用SQLite创建数据库存在以下三个比较明显的问题：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token comment">//表名、列名</span>
<span class="token keyword">const</span> <span class="token keyword">val</span> TABLE_NAME <span class="token operator">=</span> <span class="token string">&quot;table_cache&quot;</span>
<span class="token keyword">const</span> <span class="token keyword">val</span> COLUMN_NAME_KEY <span class="token operator">=</span> <span class="token string">&quot;cache_key&quot;</span>
<span class="token keyword">const</span> <span class="token keyword">val</span> COLUMN_NAME_DATA <span class="token operator">=</span> <span class="token string">&quot;cache_data&quot;</span>

<span class="token comment">//建表 SQL，是不是很容易犯错，如果使用Java就更容易犯错了</span>
<span class="token comment">//即使你说这些我信手拈来，但是依然很繁琐</span>
<span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> SQL_CREATE_TABLE_CACHE <span class="token operator">=</span>
        <span class="token string">&quot;CREATE TABLE <span class="token interpolation variable">$TABLE_NAME</span> (&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;<span class="token interpolation variable">$ID</span> INTEGER PRIMARY KEY,&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;<span class="token interpolation variable">$COLUMN_NAME_TITLE</span> TEXT,&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;<span class="token interpolation variable">$COLUMN_NAME_SUBTITLE</span> TEXT)&quot;</span>

<span class="token keyword">class</span> <span class="token function">CacheDbHelper</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">SQLiteOpenHelper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>     DATABASE_NAME<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> DATABASE_VERSION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">val</span> DATABASE_VERSION <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">const</span> <span class="token keyword">val</span> DATABASE_NAME <span class="token operator">=</span> <span class="token string">&quot;cache.db&quot;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>db<span class="token operator">:</span> SQLiteDatabase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>SQL_CREATE_TABLE_CACHE<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onUpgrade</span><span class="token punctuation">(</span>db<span class="token operator">:</span> SQLiteDatabase<span class="token punctuation">,</span> oldVersion<span class="token operator">:</span> Int<span class="token punctuation">,</span> newVersion<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//根据oldVersion和newVersion编写相应的SQL语句对数据库进行升级 </span>
        <span class="token comment">//在实际应用中，这是比较难处理的一部分，因为缺少必要的验证，极容易出错</span>
  <span class="token punctuation">}</span>

    <span class="token comment">//基类中包含了两个重要的方法 getWritableDatabase() 和   getReadableDatabase()</span>
    <span class="token comment">//这是我们操作数据库的入口</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li>SQL语句的正确性及安全性都没有保证，问题被延迟到了运行时才能被发现；</li> <li>极容易在主线程对数据库进行操作；</li> <li>从数据库数据到我们所需要的类数据之间的转换繁琐。</li></ul> <p>那么使用Room创建数据库呢，下面我们来看下Room是如何创建数据库的。</p> <p>Room数据库创建三部曲：</p> <p><strong>1.首先仍是添加依赖：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>implementation <span class="token string">&quot;androidx.room:room-runtime:2.2.5&quot;</span>
kapt <span class="token string">&quot;androidx.room:room-compiler:2.2.5&quot;</span>
</code></pre></div><p><strong>2.创建Room数据库必备三大件</strong></p> <ul><li><strong>@Entity：</strong> 表示数据库中的标；</li> <li><strong>@DAO：</strong> 数据操作对象；</li> <li><strong>@Database数据库：</strong> 必须是扩展RoomDatabase的抽象类。在注解中添加与数据库关联的数据表。包含使用@Dao注解标记的类的抽象方法。</li></ul> <h3 id="第一步-定义数据库的表"><a href="#第一步-定义数据库的表" class="header-anchor">#</a> 第一步，定义数据库的表</h3> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token comment">//定义表非常简单，只需要创建一个class ,并标记上Entity注解,可以使用它的`tableName`属性声明该表的名称</span>
  <span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;table_cache&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">class</span> Cache <span class="token punctuation">{</span>
    <span class="token comment">//1.）对于一个表来说，他必须存在一个不为空的主键 也就是必须要标记PrimaryKey和NonNull两个注解</span>
    <span class="token comment">//PrimaryKey注解的`autoGenerate`属性意味该主键的值，是否由数据库自动生成</span>
    <span class="token comment">//由于我们这里是字符串的主键key，所以我们想要自己指定他得值，</span>
    <span class="token comment">//如果是Long,INT类型的主键key，可以选择由数据库自动生成</span>
    <span class="token annotation builtin">@PrimaryKey</span><span class="token punctuation">(</span>autoGenerate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> 
    <span class="token annotation builtin">@NonNull</span>
    <span class="token keyword">var</span> key<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
    
    <span class="token comment">//2.）该字段在数据库表中的列名称，不指定的默认就等于该字段的名字</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;cache_data&quot;</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">&quot;default value&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> <span class="token keyword">data</span><span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    
    <span class="token comment">//3.)如果不想让该字段映射成表的列，可以使用该注解标记</span>
    <span class="token annotation builtin">@Ignore</span>
    <span class="token keyword">var</span> timeStamp<span class="token operator">:</span>Long<span class="token operator">?</span><span class="token operator">=</span><span class="token keyword">null</span>
    
    <span class="token comment">//4.) 如果想让内嵌对象中的字段也一同映射成 数据库表的字段，可以使用Embedded注解。此时User对象中所有字段也会一同出现在cache表中</span>
    <span class="token comment">//他又要求 User 对象必须也使用Entity注解标记，并且拥有一个不为空的主键才可以   </span>
    <span class="token annotation builtin">@Embedded</span>
    <span class="token keyword">var</span> user<span class="token operator">:</span> User<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    
     <span class="token comment">//5.)对于一个Room数据库的表而言，还有很多其他注解和属性可以使用，诸如索引，外键，关系数据支持的特性room都支持。但对于客户端来说一般也用不到，以上这些就够用了。</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="第二步-定义数据库数据操作对象"><a href="#第二步-定义数据库数据操作对象" class="header-anchor">#</a> 第二步，定义数据库数据操作对象</h3> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token annotation builtin">@Dao</span>    全称<span class="token punctuation">(</span><span class="token keyword">data</span> access <span class="token keyword">object</span><span class="token punctuation">)</span>
  <span class="token keyword">interface</span> CacheDao <span class="token punctuation">{</span>
    <span class="token comment">//1.）如果是插入数据,只需要标记上Insert注解，并指明插入数据时如果已存在一条主键一样的数据，执行什么策略</span>
    <span class="token comment">//REPLACE: 直接替换老数据</span>
    <span class="token comment">//ABORT:终止操作，并回滚事务，也就是老数据不影响</span>
    <span class="token comment">//IGNORE:忽略冲突，但是会插入失败</span>
    <span class="token annotation builtin">@Insert</span><span class="token punctuation">(</span>onConflict <span class="token operator">=</span> OnConflictStrategy<span class="token punctuation">.</span>REPLACE<span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">saveCache</span><span class="token punctuation">(</span>cache<span class="token operator">:</span> Cache<span class="token punctuation">)</span><span class="token operator">:</span> Long
    
    <span class="token comment">//2.)常规查询操作，此时还是需要你写sql语句的</span>
    <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;select * from table_cache where `key`=:primaryKey&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">getCache</span><span class="token punctuation">(</span>primaryKey<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Cache<span class="token operator">?</span>  
   
     <span class="token comment">//3.) 高级查询操作，可以通过livedata 以观察者的形式获取数据库数据，可以避免不必要的npe</span>
         <span class="token comment">//更重要的是 他可以监听数据库表中的数据的比变化。一旦发生了 insert update delete。</span>
         <span class="token comment">//room会自动读取表中最新的数据，发送给UI层 刷新页面</span>
         <span class="token comment">//这一点是我们着重要关注的，看它背后有什么骚操作。</span>
    <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;select * from table_cache&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">query2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> LiveData<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Cache<span class="token operator">&gt;</span><span class="token operator">&gt;</span>  <span class="token comment">//rxjava observer 也是支持的</span>

   <span class="token comment">//4.）删除操作非常简单 ，也可以执行sql的删除数据</span>
    <span class="token annotation builtin">@Delete</span><span class="token punctuation">(</span>entity <span class="token operator">=</span> Cache<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">deleteCache</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">)</span>

    <span class="token comment">//5.) 更新操作，也非常简单，表中对应的这一行所有数据会被替换成Cache对象的字段值</span>
    <span class="token annotation builtin">@Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>cache<span class="token operator">:</span> Cache<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="第三步-定义数据库-并关联上标和数据操作实体"><a href="#第三步-定义数据库-并关联上标和数据操作实体" class="header-anchor">#</a> 第三步，定义数据库，并关联上标和数据操作实体</h3> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token comment">// TypeConverters用以声明该数据库支持的类型转换，比如下面定义的DateConvert里面就定义Date类型的字段，存储数据库的时候会被转换成Long, 而该字段被读取的时候，会被转换成Date类型</span>
    <span class="token annotation builtin">@TypeConverters</span><span class="token punctuation">(</span>DateConvert<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> 
    <span class="token annotation builtin">@Database</span><span class="token punctuation">(</span>entities <span class="token operator">=</span> <span class="token punctuation">[</span>Cache<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">]</span><span class="token punctuation">,</span> version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">abstract</span> <span class="token keyword">class</span> CacheDatabase <span class="token operator">:</span> <span class="token function">RoomDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//1）.创建内存数据库,也就是说这种数据库当中存储的数据，只会存留在内存当中，进程被杀死之后，数据随之丢失</span>
      
       <span class="token keyword">val</span> database<span class="token operator">=</span>  Room<span class="token punctuation">.</span><span class="token function">inMemoryDatabaseBuilder</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>CacheDatabase<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token comment">//2）.创建本地持久化的数据库</span>
       <span class="token keyword">val</span> database <span class="token operator">=</span> Room<span class="token punctuation">.</span><span class="token function">databaseBuilder</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> CacheDatabase<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">,</span> <span class="token string">&quot;howow_cache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                           <span class="token comment">//是否允许在主线程上操作数据库，默认false。</span>
                           <span class="token comment">//相比sqlite无明文禁止即可为来说，Room给出了规范</span>
                          <span class="token punctuation">.</span><span class="token function">allowMainThreadQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                          <span class="token comment">//数据库创建和打开的事件会回调到这里，可以再次操作数据库</span>
                          <span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
                          <span class="token comment">//指定数据查询数据时候的线程池,</span>
                          <span class="token punctuation">.</span><span class="token function">setQueryExecutor</span><span class="token punctuation">(</span>cacheThreadPool<span class="token punctuation">)</span>
                          <span class="token comment">//它是用来创建supportsqliteopenhelper</span>
                          <span class="token comment">//可以利用它实现自定义的sqliteOpenHelper，来实现数据库的加密存储，默认是不加密的</span>
                         <span class="token punctuation">.</span><span class="token function">openHelperFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                         <span class="token comment">//数据库升级 1---2</span>
                         <span class="token punctuation">.</span><span class="token function">addMigrations</span><span class="token punctuation">(</span>migration1_2<span class="token punctuation">)</span>
                         
   <span class="token comment">//3）. 以抽象方法的形式声明数据操作对象Dao</span>
   kotlin  <span class="token keyword">abstract</span> <span class="token keyword">val</span> cacheDao<span class="token operator">:</span> CacheDao
      
   <span class="token comment">//这里演示下数据库从version1-&gt;version2的升级过程</span>
   <span class="token comment">//注意，一旦数据库被创建，只要任意对象的任意字段有改动</span>
   <span class="token comment">//Database注解的version字段都需要升级，同时需要指定升级的行为migration。</span>
   <span class="token keyword">val</span> migration1_2 <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span><span class="token function">Migration</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">migrate</span><span class="token punctuation">(</span>database<span class="token operator">:</span> SupportSQLiteDatabase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                database<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span><span class="token string">&quot;alter table table_cache add column cache_time LONG&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">class</span> DateConvert <span class="token punctuation">{</span>
       <span class="token comment">//每个类可以拥有多个TypeConverter方法，但都必须要有返回值，可空</span>
       <span class="token annotation builtin">@TypeConverter</span>
       <span class="token keyword">fun</span> <span class="token function">date2Long</span><span class="token punctuation">(</span>date<span class="token operator">:</span> Date<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>
             <span class="token keyword">return</span> date<span class="token punctuation">.</span>time
      <span class="token punctuation">}</span>
        <span class="token annotation builtin">@TypeConverter</span>
       <span class="token keyword">fun</span> <span class="token function">long2Date</span><span class="token punctuation">(</span>timestamp<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Date <span class="token punctuation">{</span>
             <span class="token keyword">return</span> <span class="token function">Date</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</code></pre></div><h2 id="据库创建实现原理"><a href="#据库创建实现原理" class="header-anchor">#</a> 据库创建实现原理</h2> <h3 id="room数据抽象设计"><a href="#room数据抽象设计" class="header-anchor">#</a> Room数据抽象设计</h3> <p>我们知道Room数据库是SQLite的抽象设计。Room的架构可以分为三层：第三层是抽象接口层，这一层主要把原本SQLite的能力抽象成接口的形式。比如SupportSqliteOpenHelper这里面就定义了获取数据库对象的方法，以及数据库打
开之后的方法回调的接口。</p> <p>那么它的实现在上一层的FrameworkSqliteOpenHelper，这一层就是直接依靠SQLite来实现相应的能力了。FrameworkSqliteOpenHelper在Room数据库架构中有着承上启下的作用。是Room和SQLite连接的桥梁。</p> <p>除此之外，Room还定义了抽象数据库接口叫做SupportSqliteDatabase，这里面我们看到也是定义增删改查和事务提交的方法，它具体的实现也是上一层的
FrameworkSqliteDatabse。这个类自然也是直接依靠SQLiteDatabase来实现相应的能力。</p> <p>可以看到，<strong>Room实际上是通过抽象接口的形式，对数据库常用的操作做了一把适配</strong>。那么有一天不再依靠SQLite，那么只需要替换掉这里的实现层即可。</p> <p>底层接口和上层Room封装都不需要动。我们应用层也不需要动。而<strong>Room实现层就是通过注解+编译时处理器的形式生成相应的实现</strong>类来解放我们帮我们完成功能
的，Room整体设计是这么一个理念。</p> <p><img src="https://gitee.com/jarrysong/img/raw/master/img/20201128222928.png" alt=""></p> <h3 id="数据库创建流程"><a href="#数据库创建流程" class="header-anchor">#</a> 数据库创建流程</h3> <p>这个流程比较简单，我就不贴代码一行行的解释了，可以对照下图，自行阅读源码：</p> <p><img src="https://gitee.com/jarrysong/img/raw/master/img/20201128223105.png" alt=""></p> <h2 id="room搭配livedata监听数据变更自动刷新页面实现原理"><a href="#room搭配livedata监听数据变更自动刷新页面实现原理" class="header-anchor">#</a> Room搭配LiveData监听数据变更自动刷新页面实现原理</h2> <p><strong>Room搭配LiveData数据懒加载</strong></p> <p>第一次向LiveData注册Observer时触发onActive，从而触发首次数据的懒加载。数据的加载在RefreshRunnable中完成，首次加载数据时会向InvalidationTracker注
册监听表数据变更的observer，一旦表数据变更了，则会再次触发RefreshRunnable加载最新数据。</p> <p><img src="https://gitee.com/jarrysong/img/raw/master/img/20201128223314.png" alt=""></p> <p><strong>数据库数据变更监听</strong></p> <p>增删改三种操作开始之前会向一张表中写入本次操作的表的成名，并将状态置为1，操作完成后会触发InvalidationTracker.endTranstions。进而查询出所有数据
变更了的表。</p> <p>然后回调给每一个RoomTracklingLiveData再次执行refreshRunnable重新加载数据，并发送到UI层的observer刷新页面。</p> <p><img src="https://gitee.com/jarrysong/img/raw/master/img/20201128223647.png" alt=""></p> <p><strong>LiveData是如何被创建出来的？</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">CacheDao_Impl</span> <span class="token keyword">extends</span> <span class="token class-name">CacheDao</span><span class="token punctuation">{</span>
      <span class="token keyword">public</span> <span class="token class-name">LiveData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Cache</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">query2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">final</span> <span class="token class-name">String</span> _sql <span class="token operator">=</span> <span class="token string">&quot;select * from table_cache&quot;</span><span class="token punctuation">;</span>
          <span class="token keyword">final</span> <span class="token class-name">RoomSQLiteQuery</span> _statement <span class="token operator">=</span> <span class="token class-name">RoomSQLiteQuery</span><span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span>_sql<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> __db<span class="token punctuation">.</span><span class="token function">getInvalidationTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createLiveData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;table_cache&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Cache</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Cache</span><span class="token punctuation">&gt;</span></span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                   <span class="token comment">//一旦向LiveData注册第一个观察则的时候，才会触发这个回调</span>
                   <span class="token comment">//也就是通过RoomDatabase去查询table_cache最新的数据</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>RoomTrackingLiveData<strong>数据加载</strong>：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">RoomTrackingLiveData</span> <span class="token keyword">extends</span> <span class="token class-name">LiveData</span><span class="token punctuation">{</span>
      <span class="token class-name">RoomTrackingLiveData</span><span class="token punctuation">(</span><span class="token class-name">RoomDatabase</span> database<span class="token punctuation">,</span><span class="token class-name">InvalidationLiveDataContainer</span> container<span class="token punctuation">,</span>  <span class="token keyword">boolean</span> inTransaction<span class="token punctuation">,</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> computeFunction<span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tableNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           mDatabase <span class="token operator">=</span> database<span class="token punctuation">;</span>
           mInTransaction <span class="token operator">=</span> inTransaction<span class="token punctuation">;</span>
          <span class="token comment">//在 RoomTrackingLiveData的构造函数里面做了两件事</span>
          <span class="token comment">//首先是把上一步的Callable这个callback回调保存了下来，等待需要加载数据的时候会回调出去</span>
          mComputeFunction <span class="token operator">=</span> computeFunction<span class="token punctuation">;</span>
          mContainer <span class="token operator">=</span> container<span class="token punctuation">;</span>
      
           <span class="token comment">//其次是构建一个observer,用以监听表数据变更的行为,此时只是创建出来，还没被注册</span>
           <span class="token comment">//一旦onInvalidated方法被触发，则会触发mInvalidationRunnable，它进而会触发RefreshRunnable家在最新数据</span>
           mObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvalidationTracker</span><span class="token punctuation">.</span><span class="token class-name">Observer</span><span class="token punctuation">(</span>tableNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token annotation punctuation">@Override</span>
                      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onInvalidated</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                             <span class="token class-name">ArchTaskExecutor</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executeOnMainThread</span><span class="token punctuation">(</span>mInvalidationRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          mContainer<span class="token punctuation">.</span><span class="token function">onActive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//第一次注册观察者时 就会触发这里 去加载首次数据</span>
          <span class="token function">getQueryExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mRefreshRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token class-name">Runnable</span> mRefreshRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token annotation punctuation">@WorkerThread</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//通过AtomicBoolean的CAS保证多线程同步，向InvalidationTracker注册观察者</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegisteredObserver<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 mDatabase<span class="token punctuation">.</span><span class="token function">getInvalidationTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addWeakObserver</span><span class="token punctuation">(</span>mObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">boolean</span> computed<span class="token punctuation">;</span>
             <span class="token keyword">do</span> <span class="token punctuation">{</span>
                 computed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                 <span class="token comment">// compute can happen only in 1 thread but no reason to lock others.</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>mComputing<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token comment">// as long as it is invalid, keep computing.</span>
                     <span class="token keyword">try</span> <span class="token punctuation">{</span>
                         <span class="token class-name">T</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                         <span class="token keyword">while</span> <span class="token punctuation">(</span>mInvalid<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                             computed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                             <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                 <span class="token comment">//这里通过前面保存下来callback会掉到CacheDao_Impl的query2方法去家在数据</span>
                                 value <span class="token operator">=</span> mComputeFunction<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                             <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Exception while computing database&quot;</span>
                                       <span class="token operator">+</span> <span class="token string">&quot; live data.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                             <span class="token punctuation">}</span>
                         <span class="token punctuation">}</span>
                         <span class="token keyword">if</span> <span class="token punctuation">(</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">//加载出最新数据后 发送给观察者</span>
                             <span class="token function">postValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                         <span class="token punctuation">}</span>
                     <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                         mComputing<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>computed <span class="token operator">&amp;&amp;</span> mInvalid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>表数据变更监听</strong></p> <p>我们从下面的这端代码可以发现insert，delete，update三个操作在执行钱都不约而同的执行了__db.beginTransaction()。在操作执行后又不约而同的执行了
_db.endTransaction();</p> <p>这两个方法的作用分别是向Room库的一张表中插入一条记录，记录下当前操作的表名。和查询出所有被认为数据发生变化了的表的集合。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">CacheDao_Impl</span> <span class="token keyword">extends</span> <span class="token class-name">CacheDao</span><span class="token punctuation">{</span>
     <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RoomDatabase</span> __db<span class="token punctuation">;</span>
     <span class="token keyword">public</span> <span class="token class-name">CacheDao_Impl</span><span class="token punctuation">(</span><span class="token class-name">RoomDatabase</span> __db<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>__db <span class="token operator">=</span> __db<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Cache</span> cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        __db<span class="token punctuation">.</span><span class="token function">assertNotSuspendingTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        __db<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
        __insertionAdapterOfCache<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
        __db<span class="token punctuation">.</span><span class="token function">setTransactionSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        __db<span class="token punctuation">.</span><span class="token function">endTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Cache</span> cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       __db<span class="token punctuation">.</span><span class="token function">assertNotSuspendingTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       __db<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        __deletionAdapterOfCache<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
        __db<span class="token punctuation">.</span><span class="token function">setTransactionSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        __db<span class="token punctuation">.</span><span class="token function">endTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Cache</span> cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      __db<span class="token punctuation">.</span><span class="token function">assertNotSuspendingTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      __db<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        __updateAdapterOfCache<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
        __db<span class="token punctuation">.</span><span class="token function">setTransactionSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        __db<span class="token punctuation">.</span><span class="token function">endTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>RoomDatabase</strong></p> <p>在RoomDatabase的构造函数中创建了mInvalidationTracker对象，而且把beginTransaction，endTransaction事件分发过去。从而得以让InvalidationTracker实现表状态记录与表状态更新通知的能力。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RoomDatabase</span><span class="token punctuation">{</span>
      <span class="token keyword">public</span> <span class="token class-name">RoomDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//在构造函数中构建数据库InvalidationTracker</span>
        <span class="token comment">//用以追踪，记录数据发生变化了的表</span>
        mInvalidationTracker <span class="token operator">=</span> <span class="token function">createInvalidationTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这是个抽象方法，在子类中被实现new InvalidationTracker(this, ...,&quot;table_cache&quot;,&quot;table_user&quot;);把数据库所有表的名称传递了过去</span>
    <span class="token punctuation">}</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assertNotMainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SupportSQLiteDatabase</span> database <span class="token operator">=</span> mOpenHelper<span class="token punctuation">.</span><span class="token function">getWritableDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//进而通知InvalidationTracker去更新数据即将发生变化的表的状态</span>
        mInvalidationTracker<span class="token punctuation">.</span><span class="token function">syncTriggers</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
        database<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">endTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mOpenHelper<span class="token punctuation">.</span><span class="token function">getWritableDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">inTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//进而通知InvalidationTracker去查询出那些表的数被认定为发生了变化</span>
            mInvalidationTracker<span class="token punctuation">.</span><span class="token function">refreshVersionsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>InvalidationTracker实现表状态记录与状态查询</strong></p> <p>每张表的增删改操作，都会在这个类中被记录下来，操作完成之后会查询出所有状态变更了的表记录。进而通知RoomTrackingLiveData中注册的Observer重新加载表数据，从而实现数据变更自动查询最新数据更新UI的功能。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">InvalidationTracker</span><span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token class-name">InvalidationTracker</span><span class="token punctuation">(</span><span class="token class-name">RoomDatabase</span> database<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> tableNames<span class="token comment">//数据库表的数组[形如table_cache,table_user]) {</span>
             mDatabase <span class="token operator">=</span> database<span class="token punctuation">;</span>
             mObservedTableTracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObservedTableTracker</span><span class="token punctuation">(</span>tableNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//InvalidationTracker在创建之初就会已知数据库所有的表</span>
<span class="token comment">//syncTriggers方法 会去 遍历每个表是否已注册数据变更的obsever</span>
<span class="token comment">//如果有，则开启对这个表的状态记录，就是向room_table_modification_log这张表中写入记录</span>
<span class="token comment">//表的结构形如：       </span>
<span class="token comment">// table_id列      invalidated列</span>
<span class="token comment">// table_cache     1               //为1，就被认为数据生了变化, </span>
                                   <span class="token comment">//但table_id这列实际上记录的是表的Id(1,2,3),这里为了容易理解，写成table_name</span>
<span class="token comment">// table_cache2    0</span>
<span class="token comment">// table_cache3    0</span>
<span class="token comment">//所以所谓的自动监听数据库数据变化就是这么实现的。没有什么玄乎的地方。</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startTrackingTable</span><span class="token punctuation">(</span><span class="token class-name">SupportSQLiteDatabase</span> writableDb<span class="token punctuation">,</span> <span class="token keyword">int</span> tableId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writableDb<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>
                <span class="token string">&quot;INSERT OR IGNORE INTO &quot;</span> <span class="token operator">+</span> UPDATE_TABLE_NAME <span class="token operator">+</span> <span class="token string">&quot; VALUES(&quot;</span> <span class="token operator">+</span> tableId <span class="token operator">+</span> <span class="token string">&quot;, 0)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> tableName <span class="token operator">=</span> mTableNames<span class="token punctuation">[</span>tableId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> trigger <span class="token operator">:</span> TRIGGERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stringBuilder<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;CREATE TEMP TRIGGER IF NOT EXISTS &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">appendTriggerName</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">,</span> tableName<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; AFTER &quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; ON `&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;` BEGIN UPDATE &quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>UPDATE_TABLE_NAME<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; SET &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>INVALIDATED_COLUMN_NAME<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; = 1&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; WHERE &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>TABLE_ID_COLUMN_NAME<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; = &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; AND &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>INVALIDATED_COLUMN_NAME<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; = 0&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;; END&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            writableDb<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshVersionsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingRefresh<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//通过线程池调度mRefreshRunnable任务</span>
         mDatabase<span class="token punctuation">.</span><span class="token function">getQueryExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mRefreshRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
   <span class="token class-name">Runnable</span> mRefreshRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
             <span class="token comment">//这里就是向room_table_modification_log表中，读取出所有invalidated列的值为1的数据。</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> invalidatedTableIds <span class="token operator">=</span> <span class="token function">checkUpdatedTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>invalidatedTableIds <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>invalidatedTableIds<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mObserverMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Observer</span><span class="token punctuation">,</span> <span class="token class-name">ObserverWrapper</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> mObserverMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//这里会通过table_id找到table_name.进而通知每个RoomTrackingLiveData中注册的Observer</span>
                    <span class="token comment">//从而实现表数据变更自动查询最新数据更新UI的能力</span>
                        entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyByTableInvalidStatus</span><span class="token punctuation">(</span>invalidatedTableIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>面试时经常会闻到你有使用Room+LiveData的组合吗？它的优势是什么？Room+LiveData组合是如何监听标数据变更自动加载最新数据刷新页面的？如果你有仔细阅读文章这两个问题的答案不言而喻了。</li> <li>同学们在做业务架构设计的时候，如果对如何分层，每个类只应该干哪些事情拿捏不稳，可以参考Room的三层设计以及FrameworkSqliteOpenHelperd的职责</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/1/2020, 1:03:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/zh/android/jetpack/savedstate.html" class="prev">
        SaveState组件架构原理解析
      </a></span> <span class="next"><a href="/blog/zh/android/jetpack/workmanager.html">
        WorkManager组件架构应用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.b29a8dd7.js" defer></script><script src="/blog/assets/js/2.f6cef42b.js" defer></script><script src="/blog/assets/js/17.4908b8a7.js" defer></script>
  </body>
</html>
